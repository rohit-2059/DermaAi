<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE-edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css"
    />
    <title>Nearby Dermatologists</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        background-color: var(--navy-900);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        line-height: 1.6;
      }

      /* Professional Table Styling */
      #hospital-container {
        margin: 30px auto;
        max-width: 90%;
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 12px;
        overflow: hidden;
        background-color: #1a2a3a;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      th {
        background: linear-gradient(to right, #0077b6, #00b4d8);
        color: white;
        padding: 15px;
        font-size: 18px;
        text-align: center;
        border-bottom: 3px solid #0096c7;
      }

      td {
        padding: 12px;
        color: #e0f0ff;
        text-align: center;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      /* Alternating Row Colors */
      tbody tr:nth-child(odd) {
        background-color: rgba(255, 255, 255, 0.05);
      }

      /* Image Styling */
      td img {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      /* Make Website Links White */
      td a {
        color: white;
        font-weight: bold;
        text-decoration: underline blue;
      }

      td a:hover {
        text-decoration: underline;
      }

      /* Enhanced Form Styling */
      .form-container {
        margin: 30px auto;
        max-width: 100%;
        padding: 0;
      }

      .form-group {
        margin-bottom: 30px;
      }

      .form-group label {
        display: block;
        color: var(--neon-blue);
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 12px;
        text-shadow: 0 0 8px rgba(0, 255, 255, 0.4);
        letter-spacing: 0.5px;
      }

      .form-control {
        width: 100%;
        padding: 18px 24px;
        border: 2px solid rgba(0, 255, 255, 0.3);
        border-radius: 15px;
        background: linear-gradient(
          135deg,
          rgba(26, 42, 58, 0.8) 0%,
          rgba(19, 38, 57, 0.9) 100%
        );
        color: var(--text-color);
        font-size: 16px;
        font-weight: 500;
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        box-sizing: border-box;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2),
          inset 0 1px 0 rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--neon-blue);
        box-shadow: 0 0 25px rgba(0, 255, 255, 0.4),
          0 4px 15px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.15);
        background: linear-gradient(
          135deg,
          rgba(26, 42, 58, 0.95) 0%,
          rgba(19, 38, 57, 0.98) 100%
        );
        transform: translateY(-2px) scale(1.01);
        color: #ffffff;
      }

      .form-control::placeholder {
        color: rgba(224, 240, 255, 0.5);
        font-weight: 400;
        font-style: italic;
      }

      .form-control:focus::placeholder {
        color: rgba(224, 240, 255, 0.7);
      }

      /* Enhanced Select Dropdown */
      select.form-control {
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background: linear-gradient(
          135deg,
          rgba(26, 42, 58, 0.8) 0%,
          rgba(19, 38, 57, 0.9) 100%
        );
        padding-right: 50px;
        position: relative;
      }

      select.form-control:focus {
        background: linear-gradient(
          135deg,
          rgba(26, 42, 58, 0.95) 0%,
          rgba(19, 38, 57, 0.98) 100%
        );
      }

      /* Custom Select Arrow */
      .form-group {
        position: relative;
      }

      .form-group::after {
        content: "";
        position: absolute;
        top: 58px;
        right: 18px;
        width: 0;
        height: 0;
        border-left: 6px solid transparent;
        border-right: 6px solid transparent;
        border-top: 8px solid var(--neon-blue);
        pointer-events: none;
        transition: all 0.3s ease;
        z-index: 1;
      }

      .form-group:has(select:focus)::after {
        border-top-color: #ffffff;
        transform: translateY(-2px);
      }

      select.form-control option {
        background: var(--navy-800);
        color: var(--text-color);
        padding: 12px;
        font-weight: 500;
      }

      select.form-control option:checked {
        background: var(--neon-blue);
        color: var(--navy-900);
      }

      /* Enhanced Map Container */
      #map {
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0, 255, 255, 0.2);
        border: 2px solid rgba(0, 255, 255, 0.3);
        overflow: hidden;
        margin: 20px auto;
        transition: all 0.3s ease;
      }

      #map:hover {
        box-shadow: 0 12px 35px rgba(0, 255, 255, 0.3);
        transform: translateY(-2px);
      }

      /* Enhanced Page Title */
      .page-title {
        text-align: center;
        font-size: 2.5rem;
        margin: 30px 0;
        background: linear-gradient(135deg, var(--neon-blue), #ffffff);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 0 30px rgba(0, 255, 255, 0.5);
        font-weight: 700;
      }

      /* Enhanced Buttons */
      .btn {
        background: linear-gradient(135deg, #0077b6, #00b4d8);
        border: none;
        border-radius: 12px;
        padding: 12px 25px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 119, 182, 0.3);
        margin: 0 10px;
      }

      .btn:hover {
        background: linear-gradient(135deg, #005f8a, #0096c7);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 119, 182, 0.4);
      }

      .btn:disabled {
        background: linear-gradient(135deg, #666, #888);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      /* Container Adjustments */
      .container {
        margin: 90px auto 0; /* Adjusted for fixed header height */
        padding: 20px;
        max-width: 95%;
      }

      /* Responsive Table */
      @media (max-width: 768px) {
        .container {
          margin-top: 80px;
        }

        .form-container {
          margin: 20px 10px;
          padding: 20px;
        }

        .form-control {
          padding: 12px 16px;
          font-size: 14px;
        }

        .page-title {
          font-size: 2rem;
        }

        table {
          font-size: 14px;
        }

        td img {
          width: 60px;
          height: 60px;
        }

        #map {
          height: 300px !important;
          width: 90% !important;
        }
      }
    </style>
  </head>

  <body>
    {% include 'header.html' %}
    <div class="container">
      <h1 class="page-title">Find Nearby Dermatologists</h1>

      <div
        id="map"
        style="height: 400px; width: 100%; margin: auto; margin-top: 20px"
      ></div>

      <div class="form-container">
        <div class="form-group">
          <label for="location">Enter Your Location</label>
          <input
            type="text"
            class="form-control"
            id="autocomplete"
            placeholder="Type location or click on map..."
          />
          <small
            style="
              color: rgba(0, 255, 255, 0.7);
              font-style: italic;
              margin-top: 8px;
              display: block;
            "
          >
            Tip: Type to search OR click anywhere on the map to select location!
          </small>
        </div>

        <div class="form-group">
          <label for="radius">Select Search Radius</label>
          <select id="radius" class="form-control">
            <option value="1000">1 km - Very Close</option>
            <option value="2000">2 km - Walking Distance</option>
            <option value="5000" selected>5 km - Short Drive</option>
            <option value="10000">10 km - Medium Distance</option>
            <option value="15000">15 km - Extended Area</option>
            <option value="20000">20 km - Wide Search</option>
            <option value="25000">25 km - City-wide</option>
            <option value="50000">50 km - Regional Search</option>
          </select>
        </div>

        <div style="text-align: center; margin-top: 20px">
          <button class="btn" id="searchBtn" onclick="triggerSearch()">
            Search Dermatologists
          </button>
          <button class="btn" id="clearBtn" onclick="clearSelection()">
            Clear Selection
          </button>
        </div>
      </div>

      <div id="hospital-container">
        <table class="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Photo</th>
              <th>Phone</th>
              <th>Address</th>
              <th>Rating</th>
              <th>Website</th>
            </tr>
          </thead>
          <tbody id="places"></tbody>
        </table>
      </div>

      <div class="text-center">
        <button class="btn btn-primary" id="prevBtn" disabled>
          ← Previous
        </button>
        <button class="btn btn-primary" id="nextBtn">Next →</button>
      </div>
    </div>

    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAf_ZJQORngO5oaDc2fT_TgAFUapu04hXI&libraries=places&callback=initMap"
      async
      defer
    ></script>
    <script>
      let map, service, autocomplete, geocoder;
      let hospitals = [];
      let currentIndex = 0;
      const hospitalsPerPage = 5;
      let selectedLocation = null;
      let currentMarker = null;
      let uniqueHospitals = new Set(); // To prevent duplicates

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 28.6139, lng: 77.209 },
          zoom: 12,
        });

        // Initialize geocoder for reverse geocoding
        geocoder = new google.maps.Geocoder();

        // Set up autocomplete
        autocomplete = new google.maps.places.Autocomplete(
          document.getElementById("autocomplete"),
          { types: ["geocode"] }
        );

        // Add map click listener
        map.addListener("click", function (event) {
          handleMapClick(event.latLng);
        });

        // Add autocomplete listener
        autocomplete.addListener("place_changed", handleAutocompleteSelection);

        // Add radius change listener
        document.getElementById("radius").onchange = function () {
          if (selectedLocation) {
            triggerSearch();
          }
        };

        // Set up pagination buttons
        document
          .getElementById("prevBtn")
          .addEventListener("click", () => showHospitals(-1));
        document
          .getElementById("nextBtn")
          .addEventListener("click", () => showHospitals(1));
      }

      function handleMapClick(latLng) {
        selectedLocation = {
          lat: latLng.lat(),
          lng: latLng.lng(),
        };

        // Remove existing marker
        if (currentMarker) {
          currentMarker.setMap(null);
        }

        // Add new marker
        currentMarker = new google.maps.Marker({
          position: latLng,
          map: map,
          title: "Selected Location",
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
            scaledSize: new google.maps.Size(32, 32),
          },
          animation: google.maps.Animation.BOUNCE,
        });

        // Stop animation after 2 seconds
        setTimeout(() => {
          currentMarker.setAnimation(null);
        }, 2000);

        // Get address for clicked location and update input
        geocoder.geocode({ location: latLng }, function (results, status) {
          if (status === "OK" && results[0]) {
            const address = results[0].formatted_address;
            document.getElementById("autocomplete").value = address;
            showLocationMessage("Location selected from map!", "success");
          } else {
            const coordinates = `${latLng.lat().toFixed(6)}, ${latLng
              .lng()
              .toFixed(6)}`;
            document.getElementById(
              "autocomplete"
            ).value = `Custom Location (${coordinates})`;
            showLocationMessage(
              "Custom location selected from map!",
              "success"
            );
          }
        });

        // Center map on selected location
        map.setCenter(latLng);
        map.setZoom(14);
      }

      function handleAutocompleteSelection() {
        const place = autocomplete.getPlace();
        if (!place.geometry) {
          showLocationMessage(
            "Please select a valid location from the dropdown list.",
            "error"
          );
          return;
        }

        selectedLocation = {
          lat: place.geometry.location.lat(),
          lng: place.geometry.location.lng(),
        };

        // Remove existing marker
        if (currentMarker) {
          currentMarker.setMap(null);
        }

        // Add marker for autocomplete selection
        currentMarker = new google.maps.Marker({
          position: place.geometry.location,
          map: map,
          title: "Selected Location",
          icon: {
            url: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
            scaledSize: new google.maps.Size(32, 32),
          },
        });

        map.setCenter(place.geometry.location);
        map.setZoom(14);

        showLocationMessage("Location selected from search!", "success");
      }

      function triggerSearch() {
        // Check if location is selected either from map click or autocomplete
        const inputValue = document.getElementById("autocomplete").value.trim();

        if (!selectedLocation && !inputValue) {
          showLocationMessage(
            "Please select a location by searching or clicking on the map!",
            "error"
          );
          return;
        }

        // If there's input value but no selectedLocation, try to geocode it
        if (inputValue && !selectedLocation) {
          geocoder.geocode({ address: inputValue }, function (results, status) {
            if (status === "OK" && results[0]) {
              selectedLocation = {
                lat: results[0].geometry.location.lat(),
                lng: results[0].geometry.location.lng(),
              };
              performSearch();
            } else {
              showLocationMessage(
                "Could not find the entered location. Please try a different address.",
                "error"
              );
            }
          });
          return;
        }

        performSearch();
      }

      function performSearch() {
        // Clear previous results and reset duplicates tracker
        document.querySelector("#places").innerHTML = "";
        hospitals = [];
        uniqueHospitals.clear();
        currentIndex = 0;

        let radius = document.getElementById("radius").value;

        showLocationMessage("Searching for dermatologists...", "info");

        service = new google.maps.places.PlacesService(map);

        // Single comprehensive search instead of multiple searches
        service.nearbySearch(
          {
            location: new google.maps.LatLng(
              selectedLocation.lat,
              selectedLocation.lng
            ),
            radius: parseInt(radius),
            type: "doctor",
            keyword: "dermatologist skin doctor",
          },
          (results, status) => {
            if (
              status === google.maps.places.PlacesServiceStatus.OK &&
              results
            ) {
              // Filter results to only include dermatology-related places
              const filteredResults = results.filter((place) => {
                const name = place.name.toLowerCase();
                const types = place.types || [];
                return (
                  name.includes("dermat") ||
                  name.includes("skin") ||
                  name.includes("hair") ||
                  types.includes("doctor") ||
                  types.includes("health")
                );
              });

              // Remove duplicates using place_id
              filteredResults.forEach((place) => {
                if (!uniqueHospitals.has(place.place_id)) {
                  uniqueHospitals.add(place.place_id);
                  hospitals.push(place);
                }
              });

              callback(
                hospitals,
                hospitals.length > 0
                  ? google.maps.places.PlacesServiceStatus.OK
                  : google.maps.places.PlacesServiceStatus.ZERO_RESULTS
              );
            } else {
              callback([], google.maps.places.PlacesServiceStatus.ZERO_RESULTS);
            }
          }
        );
      }

      function clearSelection() {
        selectedLocation = null;
        document.getElementById("autocomplete").value = "";
        document.querySelector("#places").innerHTML = "";
        hospitals = [];
        uniqueHospitals.clear();
        currentIndex = 0;

        if (currentMarker) {
          currentMarker.setMap(null);
          currentMarker = null;
        }

        // Reset pagination buttons
        document.getElementById("prevBtn").disabled = true;
        document.getElementById("nextBtn").disabled = true;

        // Reset map to default location
        map.setCenter({ lat: 28.6139, lng: 77.209 });
        map.setZoom(12);

        showLocationMessage(
          "Selection cleared! You can now choose a new location.",
          "success"
        );
      }

      function showLocationMessage(message, type) {
        // Remove existing message
        const existingMessage = document.querySelector(".location-message");
        if (existingMessage) {
          existingMessage.remove();
        }

        // Create new message element
        const messageElement = document.createElement("div");
        messageElement.className = "location-message";
        messageElement.textContent = message;

        // Style based on type
        let backgroundColor, borderColor;
        switch (type) {
          case "success":
            backgroundColor = "rgba(0, 255, 0, 0.1)";
            borderColor = "#00ff00";
            break;
          case "error":
            backgroundColor = "rgba(255, 0, 0, 0.1)";
            borderColor = "#ff0000";
            break;
          case "info":
            backgroundColor = "rgba(0, 255, 255, 0.1)";
            borderColor = "#00ffff";
            break;
          default:
            backgroundColor = "rgba(255, 255, 255, 0.1)";
            borderColor = "#ffffff";
        }

        messageElement.style.cssText = `
          background: ${backgroundColor};
          border: 1px solid ${borderColor};
          border-radius: 8px;
          padding: 12px 20px;
          margin: 15px auto;
          max-width: 600px;
          text-align: center;
          color: ${borderColor};
          font-weight: 500;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
          animation: slideDown 0.3s ease;
        `;

        // Insert after form container
        const formContainer = document.querySelector(".form-container");
        formContainer.insertAdjacentElement("afterend", messageElement);

        // Remove message after 4 seconds
        setTimeout(() => {
          if (messageElement.parentNode) {
            messageElement.style.animation = "slideUp 0.3s ease";
            setTimeout(() => {
              if (messageElement.parentNode) {
                messageElement.remove();
              }
            }, 300);
          }
        }, 4000);
      }

      function callback(results, status) {
        if (
          status === google.maps.places.PlacesServiceStatus.OK &&
          results.length > 0
        ) {
          // Sort by rating (highest first) and then by name
          hospitals.sort((a, b) => {
            if (b.rating !== a.rating) {
              return (b.rating || 0) - (a.rating || 0);
            }
            return (a.name || "").localeCompare(b.name || "");
          });

          showHospitals(0);
          showLocationMessage(
            `Found ${results.length} unique dermatologists nearby!`,
            "success"
          );
        } else {
          showLocationMessage(
            "No dermatologists found nearby. Try increasing the search radius or selecting a different location.",
            "error"
          );
        }
      }

      function showHospitals(direction) {
        currentIndex += direction * hospitalsPerPage;
        if (currentIndex < 0) currentIndex = 0;
        if (currentIndex >= hospitals.length)
          currentIndex = Math.max(0, hospitals.length - hospitalsPerPage);

        document.querySelector("#places").innerHTML = "";
        let end = Math.min(currentIndex + hospitalsPerPage, hospitals.length);

        for (let i = currentIndex; i < end; i++) {
          getPlaceDetails(hospitals[i]);
        }

        document.getElementById("prevBtn").disabled = currentIndex === 0;
        document.getElementById("nextBtn").disabled =
          currentIndex + hospitalsPerPage >= hospitals.length;
      }

      function getPlaceDetails(place) {
        service.getDetails(
          { placeId: place.place_id },
          function (details, status) {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
              createTableRow(details);
            }
          }
        );
      }

      function createTableRow(place) {
        // Double-check for duplicates before creating row
        const existingRows = document.querySelectorAll("#places tr");
        for (let row of existingRows) {
          const existingName = row.cells[0]?.innerText;
          const existingAddress = row.cells[3]?.innerText;
          if (
            existingName === place.name &&
            existingAddress === (place.formatted_address || "Not available")
          ) {
            console.log(`Duplicate prevented: ${place.name}`);
            return; // Don't create duplicate row
          }
        }

        let tableBody = document.querySelector("#places");
        let row = tableBody.insertRow();

        row.insertCell(0).innerText = place.name;
        let photoUrl = place.photos
          ? place.photos[0].getUrl()
          : "https://via.placeholder.com/150";
        row.insertCell(
          1
        ).innerHTML = `<img width="100" height="100" src="${photoUrl}" alt="No Photo"/>`;
        row.insertCell(2).innerText =
          place.formatted_phone_number || "Not available";
        row.insertCell(3).innerText =
          place.formatted_address || "Not available";
        row.insertCell(4).innerText = place.rating
          ? place.rating + " stars"
          : "No rating";
        row.insertCell(5).innerHTML = place.website
          ? `<a href="${place.website}" target="_blank">Visit</a>`
          : "Not available";
      }

      // Add CSS for animations
      const style = document.createElement("style");
      style.textContent = `
        @keyframes slideDown {
          from { opacity: 0; transform: translateY(-20px); }
          to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideUp {
          from { opacity: 1; transform: translateY(0); }
          to { opacity: 0; transform: translateY(-20px); }
        }
      `;
      document.head.appendChild(style);
    </script>
  </body>
</html>
